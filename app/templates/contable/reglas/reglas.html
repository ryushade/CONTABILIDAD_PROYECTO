{% extends 'base.html' %}

{% block title %}Tormenta{% endblock %}

{% block content %}

<style>
    :root {
        --primary-color: #3b82f6;
        --secondary-color: #1e40af;
        --background-color: #f3f4f6;
        --text-color: #1f2937;
        --border-color: #e5e7eb;
        --hover-color: #eff6ff;
    }

    body {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif;
        line-height: 1.5;
        color: var(--text-color);
        margin: 0;
        padding: 0;
    }

    .sortable:hover {
        cursor: pointer;
    }

    #tipo_transaccion_info {
        display: inline-block;
        min-width: 50px;
    }

    #cuenta_debito_codigo {
        display: inline-block;
        min-width: 50px;
    }

    /* Estilos responsivos */
    @media (max-width: 768px) {
        .table-scroll {
            min-width: 100%;
        }

        .acciones {
            min-width: auto;
        }

        .dropdown-menu {
            width: 100%;
        }
    }

    /* Estilos del modal */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .modal {
        background: white;
        padding: 20px;
        border-radius: 5px;
        width: 90%;
        max-width: 500px;
    }

    /* Estilos del dropdown */
    .dropdown-menu {
        width: 100%;
    }

    .dropdown-toggle::after {
        margin-left: .255em;
    }

    /* Estilos para alinear botones */
    .align-end {
        display: flex;
        justify-content: flex-end;
    }

    .table-scroll thead th {
        position: sticky;
        top: 0;
        z-index: 1;
    }

    .confirmation-modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1050;
    }

    .confirmation-modal {
        background: white;
        padding: 20px;
        border-radius: 8px;
        width: 90%;
        max-width: 500px;
        box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.2);
        text-align: center;
    }

    th,
    td {
        padding: 10px;
    }
</style>

<div class="row align-items-center mt-2 mb-2">
    <div class="col-md-8">
        <h1 class="font-weight-bold display-8 text-left fs-3" style="font-weight: bold;">GESTIÓN DE REGLAS CONTABLES
        </h1>
        <p class="fs-6 text-gray-500">Este apartado permite crear, editar y eliminar reglas para la generación de
            asientos contables</p>
    </div>
    <div class="col-md-4 d-flex justify-content-end align-items-center mt-2 mt-md-0">
        <a class="btn btn-primary mb-2" style="margin-left: auto;" onclick="openModalAdd()">
            <i class="fa fa-plus" style="font-size: 14px;"></i> Agregar regla
        </a>
    </div>
</div>


<div class="table-container mt-2" style="border: 1px solid #ccc;">
    <table style="border: #000; width: 100%; font-size: 13px;">
        <thead>
            <tr>
                <th class="text-center" style="font-weight: bolder;">Nombre</th>
                <th class="text-align" style="font-weight: bolder;text-align: left;">Tipo de transacción</th>
                <th class="text-align" style="font-weight: bolder;text-align: right;">Cuenta débito</th>
                <th class="text-align" style="font-weight: bolder;text-align: right;">Cuenta crédito</th>
                <th class="text-center" style="font-weight: bolder;">Estado</th>
                <th class="text-center" style="font-weight: bolder;">Acciones</th>
            </tr>
        </thead>
        <tbody>
            {% for regla in reglas %}
            <tr>
                <td class="text-align" style="font-size: 14px;">{{ regla.nombre_regla }}</td>
                {% if regla.tipo_transaccion == 'venta_contado' %}
                <td class="text-align" style="font-size: 14px; text-align: left;">Venta al contado</td>
                {% else %}
                <td class="text-align" style="font-size: 14px; text-align: left;">Compra al contado</td>
                {% endif %}

                {% if regla.cuenta_debe_codigo %}
                <td class="text-align" style="font-size: 14px;text-align: right;">{{ regla.cuenta_debe_codigo }}</td>
                {% else %}
                <td class="text-align" style="font-size: 14px;text-align: right;">Ninguna</td>
                {% endif %}

                {% if regla.cuenta_haber_codigo %}
                <td class="text-align" style="font-size: 14px;text-align: right;">{{ regla.cuenta_haber_codigo }}</td>
                {% else %}
                <td class="text-align" style="font-size: 14px;text-align: right;">Ninguna</td>
                {% endif %}

                <td class="text-center">
                    <span style="font-size: 14px;font-weight: bold;" class="
                        estado 
                        {% if regla.estado == 1 %}
                            active-c
                        {% else %}
                            inactive
                        {% endif %}
                        ">
                        {% if regla.estado == 1 %}
                        Activo
                        {% else %}
                        Inactivo
                        {% endif %}
                    </span>
                </td>

                <td class="text-center acciones">
                    <span style="font-size: 14px; color: #1e40af;" class="action-button secondary view"
                        onclick="fetchReglaDetails({{ regla.id_regla }})">
                        <i class="fas fa-eye"></i>
                    </span>
                    <span style="font-size: 14px;" class="action-button secondary edit" onclick="openEditModal(
                            {{ regla.id_regla }}, 
                            '{{ regla.nombre_regla }}', 
                            '{{ regla.tipo_transaccion }}', 
                            '{{ regla.cuenta_debe_codigo if regla.cuenta_debe_codigo else '' }}', 
                            '{{ regla.cuenta_haber_codigo if regla.cuenta_haber_codigo else '' }}', 
                            {{ regla.estado }}
                        )">
                        <i class="fas fa-edit"></i>
                    </span>

                    <span style="font-size: 14px;" class="action-button secondary trash"
                        onclick="openModalDeleteRegla('{{ regla.id_regla }}', '{{ regla.nombre_regla }}')">
                        <i class="fas fa-trash"></i>
                    </span>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<div class="row mt-4 align-items-center">
    <!-- Paginación -->
    <nav aria-label="Pagination" class="col-md-8">
        <ul class="pagination">
            <!-- Botón Primero -->
            {% if page > 1 %}
            <li class="page-item">
                <a href="{{ url_for('contable.reglas', page=1, per_page=per_page) }}" class="page-link"
                    aria-label="Primera Página">
                    &laquo;&laquo;
                </a>
            </li>
            {% endif %}

            <!-- Botón Anterior -->
            {% if page > 1 %}
            <li class="page-item">
                <a href="{{ url_for('contable.reglas', page=page - 1, per_page=per_page) }}" class="page-link"
                    aria-label="Página Anterior">
                    &laquo;
                </a>
            </li>
            {% endif %}

            <!-- Números de Página -->
            {% set start_page = max(1, page - 2) %}
            {% set end_page = min(total_pages, page + 2) %}
            {% for p in range(start_page, end_page + 1) %}
            <li class="page-item {% if p == page %}active{% endif %}">
                <a href="{{ url_for('contable.reglas', page=p, per_page=per_page) }}" class="page-link"
                    aria-label="Página {{ p }}">
                    {{ p }}
                </a>
            </li>
            {% endfor %}

            <!-- Botón Siguiente -->
            {% if page < total_pages %} <li class="page-item">
                <a href="{{ url_for('contable.reglas', page=page + 1, per_page=per_page) }}" class="page-link"
                    aria-label="Página Siguiente">
                    &raquo;
                </a>
                </li>
                {% endif %}

                <!-- Botón Final -->
                {% if page < total_pages %} <li class="page-item">
                    <a href="{{ url_for('contable.reglas', page=total_pages, per_page=per_page) }}" class="page-link"
                        aria-label="Última Página">
                        &raquo;&raquo;
                    </a>
                    </li>
                    {% endif %}
        </ul>
    </nav>

    <!-- Selector de Cantidad -->
    <div class="col-md-4 text-end mt-3 mt-md-0">
        <select style="font-size: 14px;" class="form-select w-auto d-inline" onchange="location = this.value;">
            <option value="{{ url_for('contable.reglas', page=page, per_page=5) }}" {% if per_page==5 %}selected{% endif
                %}>5</option>
            <option value="{{ url_for('contable.reglas', page=page, per_page=10) }}" {% if per_page==10 %}selected{%
                endif %}>10</option>
            <option value="{{ url_for('contable.reglas', page=page, per_page=20) }}" {% if per_page==20 %}selected{%
                endif %}>20</option>
            <option value="{{ url_for('contable.reglas', page=page, per_page=100000) }}" {% if per_page==100000
                %}selected{% endif %}>Todos</option>
        </select>
    </div>


    <div class="text-center" style="font-size: 14px; margin-top: -20px;">
        {% set start_result = (page - 1) * per_page + 1 %}
        {% set end_result = min(page * per_page, total_results) %}
        <p><strong>{{ start_result }}-{{ end_result }}</strong> de <strong>{{ total_results }}</strong> resultados</p>
    </div>
</div>





<!-- Modal para Mostrar Detalles de la Regla -->
<div id="openVerModal" class="modal-overlay"
    style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); align-items: center; justify-content: center; z-index: 1050;">
    <div class="content-modal"
        style="width: 90%; max-height: 90vh; overflow-y: auto; background-color: white; border-radius: 8px; padding: 20px;">

        <!-- Modal Header -->
        <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center;">
            <h3 class="modal-title" style="font-size: 36px;">DETALLES DE LA REGLA</h3>
            <button type="button" class="modal-close" onclick="closeModalVer()"
                style="border: none; color: black; background-color: #e74c3c; font-weight: bold; font-size: 24px; width: 40px; height: 40px; border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                &times;
            </button>
        </div>

        <!-- Modal Body -->
        <div class="modal-body">
            <div class="w-full text-start mb-5">

                <!-- Nombre de la Regla -->
                <div class="card" style="margin-bottom: 20px;">
                    <div class="card-body">
                        <h6 class="card-title" style="font-weight: bold;">Nombre de la regla</h6>
                        <p id="nombre_regla" style="font-size: 14px;" class="text-muted"></p>
                        <div class="grid-container"
                            style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px;">

                            <!-- Tipo de Transacción -->
                            <div>
                                <h6 style="font-weight: bold;">Tipo de transacción</h6>
                                <span id="tipo_transaccion_info" class="badge bg-secondary"></span>
                            </div>

                            <!-- Estado -->
                            <div>
                                <h6 style="font-weight: bold;">Estado</h6>
                                <span id="estado" class="badge bg-success"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Configuración de Cuentas -->
                <div class="card" style="margin-bottom: 20px;">
                    <div class="card-body">
                        <h6 class="card-title" style="font-weight: bold;">Configuración de cuentas</h6>
                        <div class="container bg-light rounded p-4" style="background-color: #F4F4F5;">
                            <div class="row"
                                style="display: flex; flex-direction: row; justify-content: space-between;">

                                <!-- Cuenta Débito -->
                                <div style="flex: 1; margin-right: 10px;">
                                    <h6 style="font-weight: bold;">Cuenta débito</h6>
                                    <p id="cuenta_debito" style="font-size: 16px; font-weight: bold; display: block;">
                                    </p>
                                </div>

                                <!-- Cuenta Crédito -->
                                <div style="flex: 1; margin-left: 10px;">
                                    <h6 style="font-weight: bold;">Cuenta crédito</h6>
                                    <p id="cuenta_credito" style="font-size: 16px; font-weight: bold; display: block;">
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card" style="margin-bottom: 20px; display: none;">
                    <div class="card-body">
                        <h6 class="card-title" style="font-weight: bold;">Información adicional</h6>
                        <ul class="text-muted" style="font-size: 14px; list-style-type: disc; padding-left: 20px;">
                            <li>Esta regla se aplica automáticamente en transacciones de tipo <span
                                    id="tipo_transaccion"></span></li>
                        </ul>
                        <ul class="text-muted" style="font-size: 14px;list-style-type: disc;padding-left: 20px;">
                            <li>Esta regla contiene el tipo de monto: <span id="tipo_monto"> </span></li>
                        </ul>
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>


<div id="editReglaModal" class="modal-overlay"
    style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); justify-content: center; align-items: center; z-index: 1050;">
    <div class="content-modal p-4"
        style="background-color: white; max-width: 600px; max-height: 90vh; width: 100%; overflow-y: auto; border-radius: 8px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);">
        <!-- Encabezado -->
        <div class="modal-header d-flex justify-content-between align-items-center border-0 pb-3"
            style="padding-right: 10px;">
            <h3 class="modal-title" style="font-weight: bold;">EDITAR REGLA</h3>
            <button type="button" class="modal-close" onclick="closeModalEditRegla()"
                style="border: none; color: black; background-color: #e74c3c; font-weight: bold; font-size: 24px; width: 40px; height: 40px; border-radius: 8px; display: flex; align-items: center; justify-content: center;">&times;</button>
        </div>

        <!-- Cuerpo del modal -->
        <div class="modal-body">
            <form id="editReglaForm" onsubmit="submitEditForm(event)">
                <!-- Nombre de la regla -->
                <div class="mb-4">
                    <label for="nombre_regla_edit" class="form-label" style="font-weight: bold;">Nombre:</label>
                    <input type="text" id="nombre_regla_edit" name="nombre_regla" class="form-control"
                        placeholder="Ej: Registro de venta al contado" required />
                </div>

                <!-- Tipo de transacción -->
                <div class="mb-4">
                    <label for="tipo_transaccion_edit" class="form-label" style="font-weight: bold;">Tipo de
                        transacción:</label>
                    <select id="tipo_transaccion_edit" name="tipo_transaccion" class="form-select" required>
                        <option value="venta_contado">Venta al contado</option>
                        <option value="compra_contado">Compra al contado</option>
                        <option value="compra_contado_2">Compra al contado 2</option>
                        <option value="compra_contado_3">Compra al contado 3</option>
                    </select>
                </div>

                <!-- Cuenta débito -->
                <div class="mb-4">
                    <label for="cuenta_debito_edit" class="form-label" style="font-weight: bold;">Cuenta débito:</label>
                    <input type="text" id="cuenta_debito_edit" name="cuenta_debito" class="form-control"
                        placeholder="Ej: 1212" />
                </div>

                <!-- Cuenta crédito -->
                <div class="mb-4">
                    <label for="cuenta_credito_edit" class="form-label" style="font-weight: bold;">Cuenta
                        crédito:</label>
                    <input type="text" id="cuenta_credito_edit" name="cuenta_credito" class="form-control"
                        placeholder="Ej: 4010" />
                </div>

                <!-- Estado de la cuenta -->
                <div class="mb-4">
                    <label for="estado_cuenta_edit" class="form-label" style="font-weight: bold;">Estado:</label>
                    <select id="estado_cuenta_edit" name="estado_cuenta" class="form-select" required>
                        <option value="1">Activo</option>
                        <option value="0">Inactivo</option>
                    </select>
                </div>

                <!-- Botones de acción -->
                <div class="d-flex justify-content-end mt-4" style="gap: 12px;">
                    <button type="button" onclick="closeModalEditRegla()"
                        class="btn btn-secondary me-2">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Guardar</button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
    .action-button {
        padding: 4px 6px;
    }
</style>




<form id="addReglaForm" onsubmit="submitAddForm(event)">
    <div id="addAccountModal" class="modal-overlay"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); justify-content: center; align-items: center; z-index: 1050;">
        <div class="content-modal p-4"
            style="background-color: white; max-width: 600px; max-height: 90vh; width: 100%; overflow-y: auto; border-radius: 8px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);">
            <!-- Encabezado -->
            <div class="modal-header d-flex justify-content-between align-items-center border-0 pb-3"
                style="padding-right: 10px;">
                <h3 class="modal-title m-0" style="font-weight: bold;">AGREGAR NUEVA REGLA</h3>
                <button type="button" class="modal-close" onclick="closeModalAdd()"
                    style="border: none; color: black; background-color: #e74c3c; font-weight: bold; font-size: 24px; width: 40px; height: 40px; border-radius: 8px; display: flex; align-items: center; justify-content: center;">&times;</button>
            </div>

            <!-- Cuerpo del modal -->
            <div class="modal-body">
                <form>
                    <!-- Nombre de la regla -->
                    <div class="mb-4">
                        <label for="codigo_cuenta" class="form-label" style="font-weight: bold;">Nombre:</label>
                        <input type="text" id="codigo_cuenta" name="codigo_cuenta" class="form-control"
                            placeholder="Ej: Registro de venta al contado" required />
                    </div>

                    <!-- Tipo de transacción -->
                    <div class="mb-4">
                        <label for="tipo_transaccion_add" class="form-label" style="font-weight: bold;">Tipo de
                            transacción:</label>
                        <select id="tipo_transaccion_add" name="tipo_transaccion" class="form-select" required>
                            <option value="venta_contado">Venta al contado</option>
                            <option value="compra_contado">Compra al contado</option>
                            <option value="compra_contado_2">Compra al contado 2</option>
                            <option value="compra_contado_3">Compra al contado 3</option>
                        </select>

                    </div>
                    <div class="card mb-4">
                        <div class="card-body">
                            <!-- Opción Solo Débito -->
                            <div class="d-flex align-items-start mb-3">
                                <input type="checkbox" id="solo_debito_checkbox" class="form-check-input me-2 mt-1">
                                <div>
                                    <label for="solo_debito_checkbox" class="form-check-label"
                                        style="font-weight: bold;">Deudora</label>
                                    <p class="text-muted" style="font-size: 14px; margin: 0;">
                                        Marque esta opción si la regla solo registra en el debe.
                                    </p>
                                </div>
                            </div>

                            <!-- Opción Solo Crédito -->
                            <div class="d-flex align-items-start">
                                <input type="checkbox" id="solo_credito_checkbox" class="form-check-input me-2 mt-1">
                                <div>
                                    <label for="solo_credito_checkbox" class="form-check-label"
                                        style="font-weight: bold;">Acreedora</label>
                                    <p class="text-muted" style="font-size: 14px; margin: 0;">
                                        Marque esta opción si la regla solo registra en el haber.
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Cuenta débito -->
                    <div class="mb-4">
                        <label for="cuenta_debito" class="form-label">Cuenta débito:</label>
                        <input type="text" id="cuenta_debito_add" name="cuenta_debito" class="form-control"
                            placeholder="Ej: 1212" required />
                    </div>




                    <!-- Cuenta crédito -->
                    <div class="mb-4">
                        <label for="cuenta_credito" class="form-label">Cuenta
                            crédito:</label>
                        <input type="text" id="cuenta_credito_add" name="cuenta_credito" class="form-control"
                            placeholder="Ej: 4010" required />
                    </div>

                    <div class="mb-4">
                        <label for="tipo_monto_add" class="form-label" style="font-weight: bold;">Tipo de monto:</label>
                        <select id="tipo_monto_add" name="tipo_monto" class="form-select" required>
                            <option value="monto_total">Monto total</option>
                            <option value="igv">IGV</option>
                            <option value="base_imponible">Base imponible</option>
                        </select>

                    </div>

                    <!-- Estado de la cuenta -->
                    <div class="mb-4">
                        <label for="estado_cuenta" class="form-label" style="font-weight: bold;">Estado:</label>
                        <select id="estado_cuenta" name="estado_cuenta" class="form-select" required>
                            <option value="1">Activo</option>
                            <option value="0">Inactivo</option>
                        </select>
                    </div>

                    <!-- Botones de acción -->
                    <div class="d-flex justify-content-end mt-4" style="gap: 12px;">
                        <button type="button" onclick="closeModalAdd()" class="btn btn-secondary me-2">
                            <i class="fas fa-times"></i> Cancelar
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> Guardar
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</form>



<div id="deleteReglaModal" class="confirmation-modal-overlay" style="display: none;">
    <div class="confirmation-modal" style="text-align: center;">
        <div class="modal-icon" style="margin-bottom: 10px;">
            <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"></path>
                <line x1="12" y1="9" x2="12" y2="13"></line>
                <line x1="12" y1="17" x2="12.01" y2="17"></line>
            </svg>
        </div>
        <h2 class="confirmation-modal-title" style="color: rgb(30, 30, 30);">ELIMINAR REGLA</h2>
        <p class="confirmation-modal-message">¿Estás seguro que deseas eliminar esta regla?</p>
        <input type="hidden" id="deleteReglaId" value="">
        <p id="deleteReglaInfo" class="confirmation-modal-message"
            style="font-size: 18px; color: rgb(30, 30, 30); font-weight: bold;">
        </p>
        <div class="confirmation-modal-buttons"
            style="gap: 14px; display: flex; justify-content: center; margin-top: 20px;">
            <button style="border-radius: 40px; width: 150px; height: 50px; font-weight: 600;" class="btn btn-secondary"
                onclick="closeModalDeleteRegla()">No, cancelar</button>
            <button style="border-radius: 40px; width: 150px; height: 50px; font-weight: 600;" class="btn btn-danger"
                onclick="deleteRegla()">Sí, eliminar!</button>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const soloDebitoCheckbox = document.getElementById('solo_debito_checkbox');
        const soloCreditoCheckbox = document.getElementById('solo_credito_checkbox');
        const cuentaDebitoInput = document.getElementById('cuenta_debito_add');
        const cuentaCreditoInput = document.getElementById('cuenta_credito_add');

        function toggleCheckboxes() {
            if (soloDebitoCheckbox.checked) {
                soloCreditoCheckbox.checked = false;
                cuentaCreditoInput.disabled = true;
                cuentaDebitoInput.disabled = false;
            } else if (soloCreditoCheckbox.checked) {
                soloDebitoCheckbox.checked = false;
                cuentaDebitoInput.disabled = true;
                cuentaCreditoInput.disabled = false;
            } else {
                cuentaDebitoInput.disabled = false;
                cuentaCreditoInput.disabled = false;
            }
        }

        soloDebitoCheckbox.addEventListener('change', toggleCheckboxes);
        soloCreditoCheckbox.addEventListener('change', toggleCheckboxes);
    });
</script>


<script>
    document.addEventListener('DOMContentLoaded', function () {
        function fetchReglaDetails(regla_id) {
            fetch(`/contable/reglas/detalles/${regla_id}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert(data.error);
                    } else {
                        openModalVerRegla(
                            data.nombre_regla,
                            data.tipo_transaccion,
                            data.estado,
                            data.cuenta_debito_codigo,
                            data.cuenta_debito_nombre,
                            data.cuenta_credito_codigo,
                            data.cuenta_credito_nombre,
                            data.tipo_monto
                        );
                    }
                })
                .catch(error => {
                    console.error('Error al obtener los detalles de la regla:', error);
                    alert('Ocurrió un error al obtener los detalles de la regla.');
                });
        }

        function openModalVerRegla(nombre_regla, tipo_transaccion, estado, cuenta_debito_codigo, cuenta_debito_nombre, cuenta_credito_codigo, cuenta_credito_nombre, tipo_monto) {
            document.getElementById('nombre_regla').textContent = nombre_regla || "No disponible";
            document.getElementById('tipo_transaccion_info').textContent = tipo_transaccion || "No disponible";
            document.getElementById('estado').textContent = estado || "No disponible";

            const cuentaDebitoText = (cuenta_debito_codigo && cuenta_debito_nombre) ? `${cuenta_debito_codigo} - ${cuenta_debito_nombre}` : "Ninguna";
            document.getElementById('cuenta_debito').textContent = cuentaDebitoText;

            const cuentaCreditoText = (cuenta_credito_codigo && cuenta_credito_nombre) ? `${cuenta_credito_codigo} - ${cuenta_credito_nombre}` : "Ninguna";
            document.getElementById('cuenta_credito').textContent = cuentaCreditoText;

            document.getElementById('tipo_transaccion').textContent = tipo_transaccion || "No disponible";

            document.getElementById('tipo_monto').textContent = tipo_monto || "No disponible";

            document.getElementById('openVerModal').style.display = 'flex';
        }

        function closeModalVer() {
            document.getElementById('openVerModal').style.display = 'none';
        }

        window.fetchReglaDetails = fetchReglaDetails;
        window.closeModalVer = closeModalVer;
    });


</script>

<script>
    let currentReglaId = null;

    function openEditModal(reglaId, nombre, tipoTransaccion, cuentaDebito, cuentaCredito, estado) {
        console.log("Datos recibidos:", { reglaId, nombre, tipoTransaccion, cuentaDebito, cuentaCredito, estado });

        currentReglaId = reglaId;
        document.getElementById("nombre_regla_edit").value = nombre || "";
        document.getElementById("tipo_transaccion_edit").value = tipoTransaccion || "";
        document.getElementById("cuenta_debito_edit").value = cuentaDebito || "";
        document.getElementById("cuenta_credito_edit").value = cuentaCredito || "";
        document.getElementById("estado_cuenta_edit").value = estado || "";

        document.getElementById("cuenta_debito_edit").disabled = !cuentaDebito;
        document.getElementById("cuenta_credito_edit").disabled = !cuentaCredito;

        document.getElementById("editReglaModal").style.display = "flex";
    }

    function closeModalEditRegla() {
        document.getElementById("editReglaModal").style.display = "none";
    }

    // Validación para evitar caracteres no permitidos
    function validateAccountField(input) {
        const regex = /^[0-9]*$/;
        if (!regex.test(input.value)) {
            input.value = input.value.replace(/[^0-9]/g, '');
            alert("Solo se permiten números en los campos de cuenta.");
        }
    }

    // Envía el formulario de edición
    function submitEditForm(event) {
        event.preventDefault();

        const nombreRegla = document.getElementById("nombre_regla_edit").value;
        const tipoTransaccion = document.getElementById("tipo_transaccion_edit").value;
        const cuentaDebito = document.getElementById("cuenta_debito_edit").value || null;
        const cuentaCredito = document.getElementById("cuenta_credito_edit").value || null;
        const estado = document.getElementById("estado_cuenta_edit").value;

        // Verificar que al menos una cuenta esté habilitada
        if (!cuentaDebito && !cuentaCredito) {
            alert("Debe ingresar al menos una cuenta de débito o crédito.");
            return;
        }

        fetch(`/contable/reglas/actualizar_regla/${currentReglaId}`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({
                nombre_regla: nombreRegla,
                tipo_transaccion: tipoTransaccion,
                cuenta_debito: cuentaDebito,
                cuenta_credito: cuentaCredito,
                estado: estado,
            }),
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert("Regla actualizada correctamente.");
                    closeModalEdit();
                    location.reload();
                } else {
                    console.log("Error en la respuesta del servidor:", data.message);
                    alert("Error al actualizar la regla: " + data.message);
                }
            })
            .catch(error => {
                console.error("Error en la solicitud:", error);
                alert("Ocurrió un error al intentar actualizar la regla.");
            });
    }

    // Asignar evento de validación en los campos de cuentas
    document.getElementById("cuenta_debito_edit").addEventListener("input", function () {
        validateAccountField(this);
    });
    document.getElementById("cuenta_credito_edit").addEventListener("input", function () {
        validateAccountField(this);
    });
</script>


{% endblock %}