{% extends 'base.html' %}

{% block title %}Tormenta{% endblock %}

{% block content %}

<style>
    :root {
        --primary-color: #3b82f6;
        --secondary-color: #1e40af;
        --background-color: #f3f4f6;
        --text-color: #1f2937;
        --border-color: #e5e7eb;
        --hover-color: #eff6ff;
    }

    body {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif;
        line-height: 1.5;
        color: var(--text-color);
        margin: 0;
        padding: 0;
    }

    .sortable:hover {
        cursor: pointer;
    }

    #tipo_transaccion_info {
        display: inline-block;
        min-width: 50px;
    }

    #cuenta_debito_codigo {
        display: inline-block;
        min-width: 50px;
    }

    /* Estilos responsivos */
    @media (max-width: 768px) {
        .table-scroll {
            min-width: 100%;
        }

        .acciones {
            min-width: auto;
        }

        .dropdown-menu {
            width: 100%;
        }
    }

    /* Estilos del modal */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .modal {
        background: white;
        padding: 20px;
        border-radius: 5px;
        width: 90%;
        max-width: 500px;
    }

    /* Estilos del dropdown */
    .dropdown-menu {
        width: 100%;
    }

    .dropdown-toggle::after {
        margin-left: .255em;
    }

    /* Estilos para alinear botones */
    .align-end {
        display: flex;
        justify-content: flex-end;
    }

    .table-scroll thead th {
        position: sticky;
        top: 0;
        z-index: 1;
    }
</style>

<div class="row align-items-center mt-4 mb-4">
    <div class="col-md-8">
        <h1 class="font-weight-bold display-8 text-left fs-3" style="font-weight: bold;">GESTIÓN DE REGLAS CONTABLES
        </h1>
        <p class="fs-6 text-gray-500">Este apartado permite crear, editar y eliminar reglas para la generación de
            asientos contables</p>
    </div>
    <div class="col-md-4 d-flex justify-content-end align-items-center mt-2 mt-md-0">
        <a class="btn btn-primary mb-2" style="margin-left: auto;" onclick="openModalAdd()">
            <i class="fa fa-plus" style="font-size: 14px;"></i> Agregar regla
        </a>
    </div>
</div>

<div class="table-container mt-4">
    <div class="table-scroll">
        <table>
            <thead>
                <tr>
                    <th class="text-center" style="font-weight: bolder;">Nombre</th>
                    <th class="text-center" style="font-weight: bolder;">Tipo de transacción</th>
                    <th class="text-center" style="font-weight: bolder;">Cuenta débito</th>
                    <th class="text-center" style="font-weight: bolder;">Cuenta crédito</th>
                    <th class="text-center" style="font-weight: bolder;">Estado</th>
                    <th class="text-center" style="font-weight: bolder;">Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for regla in reglas %}
                <tr>
                    <td class="text-align" style="font-size: 14px;">{{ regla.nombre_regla }}</td>
                    {% if regla.tipo_transaccion == 'venta_contado' %}
                    <td class="text-center" style="font-size: 14px;">Venta al contado</td>
                    {% else %}
                    <td class="text-center" style="font-size: 14px;">Compra al contado</td>
                    {% endif %}

                    {% if regla.cuenta_debe_codigo %}
                    <td class="text-center" style="font-size: 14px;">{{ regla.cuenta_debe_codigo }}</td>
                    {% else %}
                    <td class="text-center" style="font-size: 14px;">Ninguna</td>
                    {% endif %}

                    {% if regla.cuenta_haber_codigo %}
                    <td class="text-center" style="font-size: 14px;">{{ regla.cuenta_haber_codigo }}</td>
                    {% else %}
                    <td class="text-center" style="font-size: 14px;">Ninguna</td>
                    {% endif %}

                    <td class="text-center">
                        <span style="font-size: 14px;" class="
                        estado 
                        {% if regla.estado == 1 %}
                            active-c
                        {% else %}
                            inactive
                        {% endif %}
                        ">
                            {% if regla.estado == 1 %}
                            Activo
                            {% else %}
                            Inactivo
                            {% endif %}
                        </span>
                    </td>

                    <td class="text-center acciones">
                        <span style="font-size: 14px; color: #1e40af;" class="action-button secondary view"
                            onclick="fetchReglaDetails({{ regla.id_regla }})">
                            <i class="fas fa-eye"></i>
                        </span>
                        <span style="font-size: 14px;" class="action-button secondary edit"
                            data-cuenta-id="{{ regla.id_regla }}">
                            <i class="fas fa-edit"></i>
                        </span>
                        <span style="font-size: 14px;" class="action-button secondary trash"
                            onclick="openModalDeleteRegla('{{ regla.id_regla }}', '{{ regla.nombre_regla }}')">
                            <i class="fas fa-trash"></i>
                        </span>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Modal para Mostrar Detalles de la Regla -->
<div id="openVerModal" class="modal-overlay"
    style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); align-items: center; justify-content: center; z-index: 1050;">
    <div class="content-modal"
        style="width: 90%; max-height: 90vh; overflow-y: auto; background-color: white; border-radius: 8px; padding: 20px;">

        <!-- Modal Header -->
        <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center;">
            <h3 class="modal-title" style="font-size: 36px;">DETALLES DE LA REGLA</h3>
            <button type="button" class="modal-close" onclick="closeModalVer()"
                style="border: none; color: black; background-color: #e74c3c; font-weight: bold; font-size: 24px; width: 40px; height: 40px; border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                &times;
            </button>
        </div>

        <!-- Modal Body -->
        <div class="modal-body">
            <div class="w-full text-start mb-5">

                <!-- Nombre de la Regla -->
                <div class="card" style="margin-bottom: 20px;">
                    <div class="card-body">
                        <h6 class="card-title" style="font-weight: bold;">Nombre de la regla</h6>
                        <p id="nombre_regla" style="font-size: 14px;" class="text-muted"></p>
                        <div class="grid-container"
                            style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px;">

                            <!-- Tipo de Transacción -->
                            <div>
                                <h6 style="font-weight: bold;">Tipo de transacción</h6>
                                <span id="tipo_transaccion_info" class="badge bg-secondary"></span>
                            </div>

                            <!-- Estado -->
                            <div>
                                <h6 style="font-weight: bold;">Estado</h6>
                                <span id="estado" class="badge bg-success"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Configuración de Cuentas -->
                <div class="card" style="margin-bottom: 20px;">
                    <div class="card-body">
                        <h6 class="card-title" style="font-weight: bold;">Configuración de cuentas</h6>
                        <div class="container bg-light rounded p-4" style="background-color: #F4F4F5;">
                            <div class="row"
                                style="display: flex; flex-direction: row; justify-content: space-between;">

                                <!-- Cuenta Débito -->
                                <div style="flex: 1; margin-right: 10px;">
                                    <h6 style="font-weight: bold;">Cuenta débito</h6>
                                    <p id="cuenta_debito" style="font-size: 16px; font-weight: bold; display: block;">
                                    </p>
                                </div>

                                <!-- Cuenta Crédito -->
                                <div style="flex: 1; margin-left: 10px;">
                                    <h6 style="font-weight: bold;">Cuenta crédito</h6>
                                    <p id="cuenta_credito" style="font-size: 16px; font-weight: bold; display: block;">
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Información Adicional -->
                <div class="card" style="margin-bottom: 20px;">
                    <div class="card-body">
                        <h6 class="card-title" style="font-weight: bold;">Información adicional</h6>
                        <ul class="text-muted" style="font-size: 14px; list-style-type: disc; padding-left: 20px;">
                            <li>Esta regla se aplica automáticamente en transacciones de tipo <span
                                    id="tipo_transaccion"></span></li>
                        </ul>
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        function fetchReglaDetails(regla_id) {
            fetch(`/contable/reglas/detalles/${regla_id}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert(data.error);
                    } else {
                        openModalVerRegla(
                            data.nombre_regla,
                            data.tipo_transaccion,
                            data.estado,
                            data.cuenta_debito_codigo,
                            data.cuenta_debito_nombre,
                            data.cuenta_credito_codigo,
                            data.cuenta_credito_nombre
                        );
                    }
                })
                .catch(error => {
                    console.error('Error al obtener los detalles de la regla:', error);
                    alert('Ocurrió un error al obtener los detalles de la regla.');
                });
        }

        function openModalVerRegla(nombre_regla, tipo_transaccion, estado, cuenta_debito_codigo, cuenta_debito_nombre, cuenta_credito_codigo, cuenta_credito_nombre) {
            document.getElementById('nombre_regla').textContent = nombre_regla || "No disponible";
            document.getElementById('tipo_transaccion_info').textContent = tipo_transaccion || "No disponible";
            document.getElementById('estado').textContent = estado || "No disponible";

            const cuentaDebitoText = (cuenta_debito_codigo && cuenta_debito_nombre) ? `${cuenta_debito_codigo} - ${cuenta_debito_nombre}` : "Ninguna";
            document.getElementById('cuenta_debito').textContent = cuentaDebitoText;

            const cuentaCreditoText = (cuenta_credito_codigo && cuenta_credito_nombre) ? `${cuenta_credito_codigo} - ${cuenta_credito_nombre}` : "Ninguna";
            document.getElementById('cuenta_credito').textContent = cuentaCreditoText;

            document.getElementById('tipo_transaccion').textContent = tipo_transaccion || "No disponible";

            document.getElementById('openVerModal').style.display = 'flex';
        }

        function closeModalVer() {
            document.getElementById('openVerModal').style.display = 'none';
        }

        window.fetchReglaDetails = fetchReglaDetails;
        window.closeModalVer = closeModalVer;
    });
</script>

{% endblock %}